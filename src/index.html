<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="../build/css/styles.css">
    <link 
        rel="stylesheet" 
        href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" 
        integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" 
        crossorigin="anonymous">
</head>
<body>
    <div style="display: flex;flex-direction: column;justify-content: center;align-items: center;height: 100%;">
    <div class="textarea-content">
        <div class="textarea-menu" id="editor-menu">
            <ul class="textarea-ul">
                <li><button onclick="editorModule.enableBold();" class="disabledButton" type="button" id="bold" title="Bold"><i class="fas fa-bold"></i></button></li>
                <li><button onclick="editorModule.enableItalic();" class="disabledButton" type="button" id="italic" title="Italic"><i class="fas fa-italic"></i></button></li>
                <li><button onclick="editorModule.enableUnderline();" class="disabledButton" id="underline" type="button" title="Underline"><i class="fas fa-underline"></i></button></li>
                <li><button onclick="editorModule.enableBulleted();" class="disabledButton" id="bullet" type="button" title="Bulleted list"><i class="fas fa-list"></i></button></li>
                <li><button onclick="editorModule.enableNumbered();" class="disabledButton" id="numbered" type="button" title="Numbered list"><i class="fas fa-list-ol"></i></button></li>
                <li>
                    <button type="button" class="hyperlink disabledButton" title="Hyperlink" id="link"><i class="fas fa-link"></i></button>
                    <div id="insert-link">
                        <input type="text" placeholder="URL" id="url" autocomplete="off" class="link-input">
                        <input type="text" placeholder="Text" id="text" autocomplete="off" class="link-input" style="margin-bottom: 0;">
                        <div class="submit" style="width: 100%;">
                            <input type="button" value="Insert" id="insert">
                        </div>
                    </div>
                </li>
            </ul>
        </div>
        <div id="textarea" spellcheck="false" contentEditable=true class="description" onkeyup="editorModule.completePreview();" data-text="Description" style="outline: none;">
        </div>
        <textarea id="textarea-real" name="details" style="display: none;"></textarea>
    </div>
    <div class="preview" id="preview"></div>
    </div>
    <button id="mybutton">append</button>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
 <script src="../src/functionality.js"></script> 
<script>
    editorModule.preventDefaultClick();  
    editorModule.addLink();  
    editorModule.disableTextareaButtons();

    var textarea = document.getElementById("textarea");

	textarea.addEventListener("click", function (event) {
		event = event || window.event;
    	var target = event.target || event.srcElement;

        //var clickedNode = textNodeFromPoint(this, event.clientX, event.clientY);
        var caretPosition = insertBreakAtPoint(event);

        //console.log(caretPosition.tagName);

        /*if (clickedNode) {
            editorModule.checkButtonsActive(target);
        }*/

        ///caret check code

        editorModule.checkButtonsActive(caretPosition);

        /*if(caretPosition.tagName == "B") {
        	document.getElementById("bold").classList.add("item-active");
        }
        else if(!caretPosition.classList.contains("textarea-content")) {
        	document.getElementById("bold").classList.remove("item-active");
        }

        var boldCaret = caretPosition;

        while(boldCaret.parentNode && boldCaret.parentNode.tagName !=="BODY") {
		    boldCaret = boldCaret.parentNode;
		    if(boldCaret.tagName == "B") {
		    	document.getElementById("bold").classList.add("item-active");
		    }
	    }

	    if(caretPosition.tagName == "I") {
        	document.getElementById("italic").classList.add("item-active");
        }
        else if(!caretPosition.classList.contains("textarea-content")) {
        	document.getElementById("italic").classList.remove("item-active");
        }

        var italicCaret = caretPosition;

        while(italicCaret.parentNode && italicCaret.parentNode.tagName !=="BODY") {
		    italicCaret = italicCaret.parentNode;
		    if(italicCaret.tagName == "I") {
		    	document.getElementById("italic").classList.add("item-active");
		    }
	    }

	    if(caretPosition.tagName == "U") {
        	document.getElementById("underline").classList.add("item-active");
        }
        else if(!caretPosition.classList.contains("textarea-content")) {
        	document.getElementById("underline").classList.remove("item-active");
        }

        var underlineCaret = caretPosition;

        while(underlineCaret.parentNode && underlineCaret.parentNode.tagName !=="BODY") {
		    underlineCaret = underlineCaret.parentNode;
		    if(underlineCaret.tagName == "U") {
		    	document.getElementById("underline").classList.add("item-active");
		    }
	    }

	    if(caretPosition.tagName == "LI" && caretPosition.closest("ul") != null) {
        	document.getElementById("bullet").classList.add("item-active");
        }
        else if(!caretPosition.classList.contains("textarea-content")) {
        	document.getElementById("bullet").classList.remove("item-active");
        }

        var bulletCaret = caretPosition;

        while(bulletCaret.parentNode && bulletCaret.parentNode.tagName !=="BODY") {
		    bulletCaret = bulletCaret.parentNode;
		    if(bulletCaret.tagName == "LI" && caretPosition.closest("ul") != null) {
		    	document.getElementById("bullet").classList.add("item-active");
		    }
	    }

	    if(caretPosition.tagName == "LI" && caretPosition.closest("ol") != null) {
        	document.getElementById("numbered").classList.add("item-active");
        }
        else if(!caretPosition.classList.contains("textarea-content")) {
        	document.getElementById("numbered").classList.remove("item-active");
        }

        var numbered = caretPosition;

        while(numbered.parentNode && numbered.parentNode.tagName !=="BODY") {
		    numbered = numbered.parentNode;
		    if(numbered.tagName == "LI" && caretPosition.closest("ol") != null) {
		    	document.getElementById("numbered").classList.add("item-active");
		    }
	    }*/

	    ///// caret code end 
	});

/*function textNodeFromPoint( element, x, y ) {
    var node, nodes = element.childNodes, range = document.createRange();
    for (var i = 0; node = nodes[i], i < nodes.length; i++) {
        if (node.nodeType !== 3 &&  node.nodeType !== 1) continue;
        range.selectNodeContents(node);
        if (isInside( x, y, range.getBoundingClientRect())) {
            return node;
        }
    }
    return false;
}*/

function insertBreakAtPoint(e) {
  var range;
  var textNode;
  var offset;

  if (document.caretPositionFromPoint) {
    range = document.caretPositionFromPoint(e.clientX, e.clientY);
    textNode = range.offsetNode;
    offset = range.offset;
  } else if (document.caretRangeFromPoint) {
    range = document.caretRangeFromPoint(e.clientX, e.clientY);
    textNode = range.startContainer;
    offset = range.startOffset;
  }

 return textNode.parentElement;
}

/*function isInside ( x, y, rect ) {
    return x >= rect.left  && y >= rect.top
    && x <= rect.right && y <= rect.bottom;
}*/

</script>
</html>